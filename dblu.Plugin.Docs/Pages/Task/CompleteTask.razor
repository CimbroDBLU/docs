@*
    Component for Complete a task, showing details of the element
*@

@page "/Activities/CompleteTask/{TaskId}"
@using BPMClient
@using dblu.Docs.Models
@using dblu.Portale.Plugin.Docs.Pages.Docs.Shared
@using dblu.Portale.Plugin.Docs.Classes
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject NavigationManager  _NavigationManager
@inject ProtectedSessionStorage _SessionStore
@inject dblu.Portale.Plugin.TaskListBase.Services.Camunda.CamundaService  _CamundaService
@inject dblu.Portale.Plugin.Docs.Services.AllegatiService _AttachService
@inject AuthenticationStateProvider _AuthenticationStateProvider
@inject ILogger<CompleteTask> _Logger
@inject IJSRuntime JSRuntime

<dblu.Portale.Core.UI.PageTitle nTitle="Completa attività" />

<section class="content">
    <SfCard>
    <CardHeader Title="Completa attività" />  
    <CardContent EnableSeperator="true">
    <EditItemMetadata nItem="@Item" nShowMetadata="false"></EditItemMetadata>
    </CardContent>
    <CardContent EnableSeperator="true">
        <div class="row">
            <div class="col-12">
                <SfButton OnClick="ShowDialog" CssClass="e-primary">Completa</SfButton>
                <SfButton OnClick="GoBack">Indietro</SfButton>
            </div>
        </div>
    </CardContent>

    <Toast @ref="ToastCompleteKO" nToastType="Toast.e_ToastType.Fail" nTitle="Completamento task" nContent="Completamento task NON riuscito"></Toast>

    <QuestionDialog nTitle="Conferma"
                    nText="@DialogTitle"
                    OnExitPressed="OnCloseDialog"
                    OnNoPressed="OnCloseDialog"
                    OnYesPressed="OnComplete"
                    OnClose="OnCloseDialog"
                    nShowDialog="@IsShowDialog">
    </QuestionDialog>

    <Toast @ref="ToastCompleteKO" nToastType="Toast.e_ToastType.Fail" nTitle="Completamento task" nContent="Completamento task NON riuscito"></Toast>
    <Toast @ref="ToastCompleteOK" nToastType="Toast.e_ToastType.OK" nTitle="Completamento task" nContent="Task Completato"></Toast>
    </SfCard>
</section>


@code {

    /// <summary>
    /// Task that is managed from this view
    /// </summary>
    [Parameter]
    public BPMTaskDto nTask { get; set; }

    /// <summary>
    /// List of variables of the Task
    /// </summary>
    private Dictionary<string, VariableValue> Variables { get; set; } = new();

    /// <summary>
    /// Id of the task
    /// </summary>
    [Parameter]
    public string TaskId { get; set; }

    /// <summary>
    /// Item  ID under process
    /// </summary>
    private Elementi Item { get; set; }

    /// <summary>
    /// Toaster to show in case of failed task
    /// </summary>
    private Toast ToastCompleteKO { get; set; }

    /// <summary>
    /// Toaster to show in case of completed task
    /// </summary>
    private Toast ToastCompleteOK { get; set; }

    /// <summary>
    /// Title of the complete task dialog
    /// </summary>
    private string DialogTitle { get; set; } = "";

    /// <summary>
    /// Indicateds if dialog for complete task is showed
    /// </summary>
    private bool IsShowDialog { get; set; } = false;

    /// <summary>
    /// Current UserID
    /// </summary>
    public string User{ get; set; }

    /// <summary>
    /// Initialize the collections
    /// </summary>
    protected override async  void OnInitialized()
    {
        BPMTask tsk = new BPMTask();
        if(!string.IsNullOrEmpty(TaskId))
            nTask = _CamundaService._task.Get(_CamundaService._eng, TaskId);       


        BPMVariable var = new BPMVariable();
        Variables = var.GetAll(_CamundaService._eng, nTask.id).Result;

        if (Variables.ContainsKey("IdElemento"))
            Item = _AttachService.GetElemento(Guid.Parse((string)Variables["IdElemento"].value), 0);
        else
            if (Variables.ContainsKey("_IdElemento"))
            Item = _AttachService.GetElemento(Guid.Parse((string)Variables["_IdElemento"].value), 0);

        var authState = await _AuthenticationStateProvider.GetAuthenticationStateAsync();
        User = authState.User.Identity.Name;
    }

    /// <summary>
    /// Go back to the caller
    /// </summary>
    private async void GoBack()
    {
        string back = (await _SessionStore.GetAsync<string>("Referrer")).Value;
        if (string.IsNullOrEmpty(back))
            _NavigationManager.NavigateTo($"/BPM/ActivityList");
        else
        {
            await JSRuntime.InvokeVoidAsync("BlazorSetHREF", back);        
            await _SessionStore.DeleteAsync("Referrer");
        }
    }

    /// <summary>
    /// Complete the task
    /// </summary>
    private async void OnComplete()
    {
        bool res = false;
        try
        {

            IsShowDialog = false;
            Stopwatch sw = Stopwatch.StartNew();
            BPMTask tsk = new BPMTask();

            ///Prima di avanzare il task, ne prendo possesso
            BPMTaskDto dt = tsk.Get(_CamundaService._eng, nTask.id);
            if(dt.assignee!=User )
            {
                tsk.Claim(_CamundaService._eng, nTask.id, User);
                 _Logger.LogInformation($"CompleteTask.Claim: Task {nTask.id} is in charge of {User}");
            }

            Dictionary<string, VariableValue> fVars = await tsk.GetTaskFormVariables(_CamundaService._eng, nTask.id);
            BPMTaskDto tdto = tsk.Get(_CamundaService._eng, nTask.id);
            res = tsk.SubmitTaskForm(_CamundaService._eng, nTask.id, fVars);
            if (res)
            {
                _Logger.LogInformation($"CompleteTask.Complete: Completed task {nTask.id} in {sw.ElapsedMilliseconds} ms");
                ToastCompleteOK.Show();
                GoBack();
            }
            else
            {
                ToastCompleteKO.Show();
            }
        }
        catch (Exception ex)
        {
            _Logger.LogError($"CompleteTask.Complete: Unexpected exception {ex}");
        }
    }

    /// <summary>
    /// Open the confirmation dialog
    /// </summary>
    private void ShowDialog()
    {
        DialogTitle = $"Completi il task {nTask.name} [{nTask.description}] ?";
        IsShowDialog = true;
    }

    /// <summary>
    /// Close the confirmation dialog
    /// </summary>
    private void OnCloseDialog()
    {
        IsShowDialog = false;
    }

}
