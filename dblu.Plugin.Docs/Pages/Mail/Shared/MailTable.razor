@*
    Component for showing a table with all emails
*@

@using dblu.Docs.Models
@using dblu.Docs.Classi
@using dblu.Portale.Plugin.Docs.Services
@using dblu.Portale.Core.Infrastructure.Identity.Classes
@using dblu.Portale.Core.Infrastructure.Identity.Services
@using Microsoft.AspNetCore.Http
@using System.Security.Claims
@using Syncfusion.Blazor.Data
@using System.Timers
@implements IDisposable


@inject dblu.Portale.Plugin.Docs.Services.MailService _MailService
@inject IHttpContextAccessor _HttpContextAccessor
@inject ILogger<MailTable> _Logger
@inject IConfiguration _Conf



<SfGrid @ref="@Grid" ID="@Id" EnablePersistence="true" SelectedRowIndex="0" DataSource="@nEmails"  AllowGrouping="false" TValue="AllegatoEmail" AllowTextWrap="true" AllowPaging="true" AllowSorting="true">
    <GridSelectionSettings PersistSelection="false" Type="@SelType" Mode="Syncfusion.Blazor.Grids.SelectionMode.Row"></GridSelectionSettings>
    <GridTextWrapSettings WrapMode="WrapMode.Content"></GridTextWrapSettings>
    <GridEditSettings AllowAdding="false" AllowEditing="false" AllowDeleting="false" Mode="EditMode.Batch"></GridEditSettings>
    <GridPageSettings PageSizes="true" PageSize="20"></GridPageSettings>
    <GridEvents TValue="AllegatoEmail" OnDataBound="OnDataBoundHandler" DataBound="DataBoundHandler" OnToolbarClick="OnToolbarClick" RowSelected="RowSelected" RowDeselected="RowDeselected"></GridEvents>

    <SfSpinner @bind-Visible="IsSpinnerVisible">
    </SfSpinner>

    <SfToolbar>
        <ToolbarEvents Clicked="OnToolbarClick"></ToolbarEvents>
        <ToolbarItems>
            @if (nType == TableType.Inbox || nType == TableType.Processed)
            {
                <ToolbarItem Id="Answer" PrefixIcon="e-icons e-undo" TooltipText="Rispondi"></ToolbarItem>
                <ToolbarItem Id="Forward" PrefixIcon="e-icons e-redo" TooltipText="Inoltra"></ToolbarItem>
            }
            <ToolbarItem Id="Refresh" TooltipText="Aggiorna">
                <Template>
                    <div style="position:relative">
                        <button type="button" tabindex="-1" style="width:auto" aria-label="Aggiorna" class="e-control e-btn e-lib e-tbar-btn e-icon-btn e-icon-btn">
                            <span class="e-refresh e-icons e-btn-icon">
                                @if (NewItems != 0)
                                {
                                    <span style="padding: 0.2rem;font-family:Verdana;line-height:8px;font-size: 10px; border-radius: 5px; background: Tomato; right: 0px; top: 2px; position: absolute;">@NewItems</span>
                                }
                            </span>
                        </button>
                    </div>
                </Template>
            </ToolbarItem>

            @if (nType == TableType.Inbox || nType == TableType.Sorting)
            {
                <ToolbarItem Id="Move" PrefixIcon="e-icons e-folder" TooltipText="Sposta"></ToolbarItem>
            }

            @if (nType == TableType.Processed)
            {
                <ToolbarItem Id="ReOpen" PrefixIcon="e-comment-reopen" TooltipText="Riapri"></ToolbarItem>
            }

            <ToolbarItem Id="Delete" PrefixIcon="e-icons e-delete" TooltipText="Cancella"></ToolbarItem>
            @if (nType == TableType.Inbox)
            {
                <ToolbarItem Id="ShowHTML" PrefixIcon="e-icons e-image" TooltipText="Mostra"></ToolbarItem>
            }
            <ToolbarItem Id="Log" PrefixIcon="e-icons e-justify" TooltipText="Visualizza logs"></ToolbarItem>
            <ToolbarItem Align=ItemAlign.Right Id="SearchItem" Type="ItemType.Input">
                <Template>
                    <SfTextBox @ref="@SearchText" ID="SearchItemText" EnablePersistence="false" Autocomplete="AutoComplete.On" @bind-Value="@SearchKey" @onchange="OnSearch" Placeholder="Ricerca" Created="@OnSearchCreated"></SfTextBox>
                </Template>
            </ToolbarItem>
        </ToolbarItems>
    </SfToolbar>

    <GridColumns>
        <GridColumn IsPrimaryKey="true" Visible="false" Field=@nameof(AllegatoEmail.Id)></GridColumn>
        <GridColumn AllowEditing="false" AllowSorting="true" Field=@nameof(AllegatoEmail.Mittente) HeaderText="Email">
            <Template>
                @{
                    var Attach = (context as AllegatoEmail);
                    bool IsClient = !string.IsNullOrEmpty(Attach.Chiave3);
                    <div>
                        @if (IsClient)
                        {
                            <span>Cliente: @Attach.Chiave3</span>
                            <br />
                        }
                        <b>@Attach.Chiave4</b><br />
                        @Attach.Mittente
                    </div>
                }
            </Template>
        </GridColumn>
        <GridColumn AllowEditing="false" AllowSorting="true" Field=@nameof(AllegatoEmail.Oggetto) HeaderText="Oggetto"></GridColumn>
        <GridColumn AllowEditing="false" TextAlign="TextAlign.Center" Width="120px" AllowSorting="true" Field=@nameof(AllegatoEmail.Data) HeaderText="Data" Format="dd/MM/yyyy HH:mm" Type="ColumnType.Date">
            <Template>
                @{
                    var Attach = (context as AllegatoEmail);
                    @Attach?.Data?.ToShortDateString()
                    <br />
                    @Attach?.Data?.ToShortTimeString()
                }
            </Template>
        </GridColumn>
        <GridColumn AllowEditing="false" Width="40px" AllowSorting="true" Field=@nameof(AllegatoEmail.LastOp) HeaderText="LastOp">
            <Template>
                <dblu.Portale.Plugin.Docs.Pages.Docs.Shared.LastOperation nOperation="@((context as AllegatoEmail).LastOp)"></dblu.Portale.Plugin.Docs.Pages.Docs.Shared.LastOperation>
            </Template>
        </GridColumn>
        <GridColumn AllowEditing="false" Visible="false" AllowSorting="false" Field=@nameof(AllegatoEmail.Chiave3) ></GridColumn>
    </GridColumns>
</SfGrid>


@code {


    /// <summary>
    /// Indicates if spinner must be visible
    /// </summary>
    private bool IsSpinnerVisible { get; set; } = false;


    ///// <summary>
    ///// Url to use to retreive paginated data
    ///// </summary>
    //private string DataUrl => $"/ODATA/Mails(Type='{nType.ToString()}',MailBox='{nMailBox.Nome}')";

    /// <summary>
    ///Type of mail that we need to show
    /// </summary>
    public enum TableType
    {
        /// <summary>
        /// Inbox emails
        /// </summary>
        Inbox,
        /// <summary>
        /// Processed emails
        /// </summary>
        Processed,
        /// <summary>
        /// Sent emails
        /// </summary>
        Sent,
        /// <summary>
        /// Sorting of emails
        /// </summary>
        Sorting
    };

    /// <summary>
    /// Id of the table
    /// </summary>
    public string Id => "MailTable" + nType.ToString();

    /// <summary>
    /// Mailbox that we are browsing
    /// </summary>
    [Parameter]
    public EmailServer nMailBox { get; set; }

    /// <summary>
    /// Type of maitable we are browsing
    /// </summary>
    [Parameter]
    public TableType nType { get; set; } = TableType.Inbox;

    /// <summary>
    /// Attachment we have to select if any (useful for go back)
    /// </summary>
    [Parameter]
    public string nPreselAttach { get; set; } = "";

    /// <summary>
    /// Fires when an attach is selected
    /// </summary>
    [Parameter]
    public EventCallback<(AllegatoEmail,bool)> OnSelectAttachment { get; set; }

    /// <summary>
    /// Fires when user request to reply
    /// </summary>
    [Parameter]
    public EventCallback<AllegatoEmail> OnReplyAttachment { get; set; }

    /// <summary>
    /// Fires when user request to forward
    /// </summary>
    [Parameter]
    public EventCallback<AllegatoEmail> OnForwardAttachment { get; set; }

    /// <summary>
    /// Fires when user request to move an item
    /// </summary>
    [Parameter]
    public EventCallback<AllegatoEmail> OnMoveAttachment { get; set; }

    /// <summary>
    /// Fires when user request to see source of an email
    /// </summary>
    [Parameter]
    public EventCallback<AllegatoEmail> OnShowAttachment { get; set; }

    /// <summary>
    /// Fires when user request to see operative logs
    /// </summary>
    [Parameter]
    public EventCallback<AllegatoEmail> OnShowLogsAttachment { get; set; }

    /// <summary>
    /// Fires when user request to delete an email
    /// </summary>
    [Parameter]
    public EventCallback<AllegatoEmail> OnDeleteAttachment { get; set; }

    /// <summary>
    /// Fires when user request to re-opem an email
    /// </summary>
    [Parameter]
    public EventCallback<AllegatoEmail> OnReOpenAttachment { get; set; }

    /// <summary>
    /// Reference to the grid
    /// </summary>
    private SfGrid<AllegatoEmail> Grid { get; set; }

    /// <summary>
    /// Previous selected Mailbox
    /// </summary>
    public EmailServer nMailBoxOld { get; set; }

    /// <summary>
    /// List of attachment to show
    /// </summary>
    private ObservableCollection<AllegatoEmail> nEmails { get; set; } = new();

    /// <summary>
    /// Get/set the current selected row
    /// </summary>
    public double SelectedRow { get => Grid.SelectedRowIndex; set { Grid.SelectRowAsync(value); } }

    /// <summary>
    /// Text box for seaching
    /// </summary>
    private SfTextBox SearchText { get; set; }

    /// <summary>
    /// The key text type inside search box
    /// </summary>
    private string SearchKey { get; set; } = "";

    /// <summary>
    /// New Items identifies in last check
    /// </summary>
    private int NewItems { get; set; } = 0;

    /// <summary>
    /// Timer for periodically check for new emails
    /// </summary>
    private Timer InTimer { get; set; }

    /// <summary>
    /// Last emails arrived and visualized in current folder
    /// </summary>
    private DateTime LastEmailTime { get; set; }

    /// <summary>
    /// List of previous selected indexes on the table
    /// </summary>
    private List<double> SelectedIndexes { get; set; } = new();

    /// <summary>
    /// Type of selection (single or Multi lines)
    /// </summary>
    private Syncfusion.Blazor.Grids.SelectionType SelType { get; set; } = Syncfusion.Blazor.Grids.SelectionType.Single;

    /// <summary>
    /// On init , if necessary, start the timer
    /// </summary>
    protected override async void OnInitialized()
    {

        int.TryParse(_Conf["Docs:AutoRefresh"], out int Time);
        if (Time != 0)
        {
            Time = Time * (60 * 1000);
            InTimer = new Timer();
            InTimer.Elapsed += NotifyTimerElapsed;
            InTimer.AutoReset = true;
            InTimer.Interval = Time;
            InTimer.Enabled = true;
            _Logger.LogInformation($"MailTable.OnInitialized: Autorefresh set every {Time} ms");
        }
        else _Logger.LogDebug($"MailTable.OnInitialized: Autorefresh NOT set");
    }

    /// <summary>
    /// Close the timer on dispose
    /// </summary>
    public void Dispose() => InTimer?.Dispose();

    /// <summary>
    /// Add the search icon to the text box
    /// </summary>
    public void OnSearchCreated()
    {
        this.SearchText.AddIcon("append", "e-icons e-search");
    }

    /// <summary>
    /// Apply the search
    /// </summary>
    public void OnSearch()
    {       
        Grid.Search(SearchKey);
        ClearSelectionAsync();
    }

    /// <summary>
    /// Once the time fire, check for incoming emails
    /// </summary>
    /// <param name="source"></param>
    /// <param name="e"></param>
    private void NotifyTimerElapsed(object source, ElapsedEventArgs e)
    {
        try
        {
        int tmp = NewItems;
        switch (nType)
        {
            case TableType.Inbox: NewItems = _MailService._allMan.GetNewInboxEmail("EMAIL", nMailBox.Nome, LastEmailTime); break;
            case TableType.Sorting: NewItems = _MailService._allMan.GetNewSortingEmail("EMAIL", nMailBox.Nome, LastEmailTime); break;
        }

        if (tmp != NewItems)
            InvokeAsync(() =>
            {                
                StateHasChanged();
            });
        }catch(Exception ex)
        {
            _Logger.LogError($"MailTable.NotifyTimerElapsed: Unexpcted error  {ex}");
        }
    }

    /// <summary>
    /// On Init component
    /// </summary>
    protected override Task OnParametersSetAsync()
    {

        if (nMailBox is not null)
        {
            if (nMailBoxOld != nMailBox)
            {
                Refresh();
            }
        }
        else nEmails = new();
        return base.OnParametersSetAsync();

    }

    /// <summary>
    /// Remove selected attach from grid and clear the selection
    /// </summary>
    /// <param name="AttachId">Id to remove</param>
    public void RemoveItem(string AttachId)
    {
        try
        {
            nEmails.Remove(nEmails.FirstOrDefault(x => x.Id.ToString() == AttachId));
            ClearSelectionAsync();        
        }catch(Exception ex)
        {
            _Logger.LogError($"MailTable.RemoveItem: Unexpcted error  {ex}");
        }
    }

    /// <summary>
    /// On record select forward the selection
    /// </summary>
    /// <param name="args"></param>
    public void RowSelected(RowSelectEventArgs<AllegatoEmail> args)
    {

        OnSelectAttachment.InvokeAsync((args.Data,args.IsInteracted));
        _Logger.LogDebug($"MailTable.RowSelected: Selected Attach {args.Data.Id}");
    }

    /// <summary>
    /// Get the list of selected records
    /// </summary>
    /// <returns>List of selected records</returns>
    public async Task<List<AllegatoEmail>> GetSelected()
    {
        return await Grid.GetSelectedRecordsAsync();
    }

    /// <summary>
    /// On record select forward the selection
    /// </summary>
    /// <param name="args"></param>
    public async void RowDeselected(RowDeselectEventArgs<AllegatoEmail> args)
    {
        if ((await Grid.GetSelectedRecordsAsync()).Count == 0)
        {
            _Logger.LogDebug($"MailTable.RowDeselected: Deselected Attach {args.Data.Id}");
            await OnSelectAttachment.InvokeAsync((null,args.IsInteracted));
        }
    }

    /// <summary>
    /// Forward the events on toolbar button press
    /// </summary>
    /// <param name="args"></param>
    public async void OnToolbarClick(Syncfusion.Blazor.Navigations.ClickEventArgs args)
    {
        AllegatoEmail Attach = (await Grid.GetSelectedRecords()).FirstOrDefault();

        if (Attach == null) return;

        if (args.Item.Id == "Answer")
            await OnReplyAttachment.InvokeAsync(Attach);
        else if (args.Item.Id == "Forward")
            await OnForwardAttachment.InvokeAsync(Attach);
        else if (args.Item.Id == "Refresh")
            Refresh();
        else if (args.Item.Id == "Move")
            await OnMoveAttachment.InvokeAsync(Attach);
        else if (args.Item.Id == "ShowHTML")
            await OnShowAttachment.InvokeAsync(Attach);
        else if (args.Item.Id == "Log")
            await OnShowLogsAttachment.InvokeAsync(Attach);
        else if (args.Item.Id == "Delete")
            await OnDeleteAttachment.InvokeAsync(Attach);
        else if (args.Item.Id == "ReOpen")
            await OnReOpenAttachment.InvokeAsync(Attach);
    }


    /// <summary>
    /// Reload the list fo the email and get last email for this folder
    /// </summary>
    public async void Refresh()
    {
        try
        {

            if (nMailBoxOld == nMailBox)
            {
                SelectedIndexes.Clear();
                List<double> T = (await Grid.GetSelectedRowIndexesAsync()).ToList();
                foreach (var index in T)
                    SelectedIndexes.Add(index);
                Grid.ClearSelectionAsync();
            }
            else
                ClearSelectionAsync();

            nMailBoxOld = nMailBox;
            IsSpinnerVisible = true;


            Task.Run(async () =>
             {
                 try
                 {
                     Stopwatch sw = Stopwatch.StartNew();

                     switch (nType)
                     {
                         case TableType.Inbox:
                             nEmails = new ObservableCollection<AllegatoEmail>(_MailService._allMan.GetEmailInArrivo("EMAIL", nMailBox.Nome).OrderBy(c => c.DataC));
                             _Logger.LogInformation($"Inbox.Refresh[{TableType.Inbox},{nMailBox.Nome}]: {nEmails.Count} emails detected in {sw.ElapsedMilliseconds} ms");
                             break;
                         case TableType.Sorting:
                             SelType = Syncfusion.Blazor.Grids.SelectionType.Multiple;
                             nEmails = new ObservableCollection<AllegatoEmail>(_MailService._allMan.GetEmailDaSmistare("EMAIL", nMailBox.Nome).OrderBy(c => c.DataC));
                             _Logger.LogInformation($"Inbox.Refresh[{TableType.Inbox},{nMailBox.Nome}]: {nEmails.Count} emails detected in {sw.ElapsedMilliseconds} ms");
                             break;
                         case TableType.Processed:
                             nEmails = new ObservableCollection<AllegatoEmail>(_MailService._allMan.GetEmailProcessate("EMAIL", nMailBox.Nome).OrderBy(c => c.DataC));
                             _Logger.LogInformation($"Inbox.Refresh[{TableType.Inbox},{nMailBox.Nome}]: {nEmails.Count} emails detected in {sw.ElapsedMilliseconds} ms");
                             break;
                         case TableType.Sent:
                             nEmails = new ObservableCollection<AllegatoEmail>(_MailService._allMan.GetEmailInviate("EMAIL", nMailBox.Nome).OrderBy(c => c.DataC));
                             _Logger.LogInformation($"Inbox.Refresh[{TableType.Inbox},{nMailBox.Nome}]: {nEmails.Count} emails detected in {sw.ElapsedMilliseconds} ms");
                             break;
                     }


                     switch (nType)
                     {
                         case TableType.Inbox: LastEmailTime = _MailService._allMan.GetLastInboxEmailTime("EMAIL", nMailBox.Nome); break;
                         case TableType.Sorting: LastEmailTime = _MailService._allMan.GetLastSortingEmailTime("EMAIL", nMailBox.Nome); break;
                     }
                     NewItems = 0;
                     InvokeAsync(async () =>
                     {
                         await Task.Delay(500);
                         Grid.Refresh();
                         IsSpinnerVisible = false;
                     });
                 }
                 catch (Exception ex)
                 {
                     _Logger.LogError($"MailTable.Refresh(1): Unexpcted error  {ex}");
                 }
             }
            );
        }catch(Exception ex)
        {
            _Logger.LogError($"MailTable.Refresh: Unexpcted error  {ex}");
        }
    }

    /// <summary>
    /// On reloading list of email set the search
    /// </summary>
    /// <param name="args"></param>
    public async void OnDataBoundHandler(BeforeDataBoundArgs<AllegatoEmail> args)
    {
        SearchKey = Grid.SearchSettings.Key;
    }

    /// <summary>
    /// Clear the selection
    /// </summary>
    public  void ClearSelectionAsync() 
    {
        try
        {
            SelectedIndexes.Clear(); Grid.ClearSelection();
        }
        catch(Exception ex)
        {
             _Logger.LogError($"MailTable.ClearSelectionAsync: Unexpcted error  {ex}");
        }
    }

    /// <summary>
    /// Page in witch i am searching th selection (sometimes seems not keep the page so, if i cannot find the item, i search from page 1 to )
    /// </summary>
    private int Page{ get; set; } = 1;


    /// <summary>
    /// On databound check id there is content, to send selection properly
    /// </summary>
    public async void DataBoundHandler()
    {
        try
        { 
            foreach (var index in SelectedIndexes)               
                await Grid.SelectRowAsync(index);

            if ((await Grid.GetSelectedRecordsAsync()).Count != 0)
                return;


            _Logger.LogDebug("MailTable.DataBoundHandler: Selection empty -> AutoSelection needed");

            if (Grid.CurrentViewData.Count() == 0)
            {
                await OnSelectAttachment.InvokeAsync((null,false));
                _Logger.LogDebug("MailTable.DataBoundHandler:  Auto Deselect");
            }
            else
            {

                if (!string.IsNullOrEmpty(nPreselAttach))
                {
                    AllegatoEmail e = Grid.CurrentViewData.Where(x => (x as AllegatoEmail).Id == Guid.Parse(nPreselAttach)).FirstOrDefault() as AllegatoEmail;

                    var PrimayIndex = await this.Grid.GetRowIndexByPrimaryKey(Guid.Parse(nPreselAttach));
                    if(PrimayIndex==-1 && Page < 100 && nEmails.Any(x=>x.Id==Guid.Parse(nPreselAttach)))
                    {
                        await Grid.GoToPageAsync(Page++);
                        return;
                    }
                    Page = 1;

                    await this.Grid.SelectRow(PrimayIndex);
                    OnSelectAttachment.InvokeAsync((e,false));
                    _Logger.LogDebug($"MailTable.DataBoundHandler: Select Presel {PrimayIndex}");
                }
                else
                {
                    //AllegatoEmail e = (Grid.CurrentViewData).FirstOrDefault() as AllegatoEmail;
                    //var PrimayIndex = await this.Grid.GetRowIndexByPrimaryKey(e.Id);
                    //await this.Grid.SelectRow(PrimayIndex);
                    //OnSelectAttachment.InvokeAsync((e,false));
                    //_Logger.LogDebug("MailTable.DataBoundHandler: Select First");
                }
            }
        }
        catch (Exception ex)
        {
            _Logger.LogWarning("MailTable.DataBoundHandler: Items changed during loading...");
        }
    }
}
