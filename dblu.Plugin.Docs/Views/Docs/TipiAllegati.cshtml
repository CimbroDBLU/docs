@model dblu.Docs.Models.TipiAllegati
@using dblu.Docs.Classi

@using dblu.Portale.Plugin.Docs.ViewModels
@using Kendo.Mvc.UI
@addTagHelper *, Kendo.Mvc
@{
    ViewData["Title"] = "Tipi di Allegati";
}

<section class="content-header">
    <h1>
        Tipi di Allegati
    </h1>
    <ol class="breadcrumb">
        <li><a href="/Index"><i class="fa fa-dashboard"></i>Home</a></li>
        <li><a href="/Docs/TipiAllegati">TipiAllegati</a></li>
    </ol>
</section>


<!-- Main content -->
<section class="content">
    <div>
        @(Html.Kendo().Dialog()
        .Name("dialogConferma")
        .ButtonLayout("normal")
        .Title("Attenzione")
        .Content("<p>Confermi di eliminare il tipo allegato?<p>")
        .Width(400)
        .Modal(false)
        .Closable(true)
        .Visible(false)
        .Actions(actions =>
        {
            actions.Add().Text("Cancel").Action("onAnnullaEliminazione");
            actions.Add().Text("Ok").Primary(true).Action("onConfermaEliminazione");
        })
    )
    </div>
    <div class="row">
        <div class="col-xs-12">
            <div class="box box-solid box-default">
                <div class="box-header with-border">
                    @*     <h3 class="box-title">Categorie</h3>*@
                    @Html.Hidden("CodTipo")
                </div>
                <div class="box-body">

                    @(Html.Kendo().Grid<dblu.Docs.Models.TipiAllegati>()
            .Name("gridTipiAllegati")
            .Columns(columns =>
            {
                columns.Bound(p => p.Codice).Width(100);
                columns.Bound(p => p.Descrizione).Width(500);
                columns.Bound(p => p.Cartella).Width(200);
                columns.Bound(p => p.ViewAttributi).Width(200);
                columns.Command(command =>
                {
                    command.Custom("Modifica").Click("showEditor");
                    command.Custom("Elimina").Click("eliminaTipoAllegato");
                    command.Custom("Duplica").Click("duplica");
                }).Width(500);
            })
            //.ToolBar(toolbar => toolbar.Create())
            .ToolBar(toolbar =>
            {
                toolbar.Custom().Text("Nuovo Allegato").HtmlAttributes(new { id = "AddTipoAllegato" });
            })
            .Editable(editable => editable.Mode(GridEditMode.PopUp))
            .Pageable()
            .Sortable()
            .Scrollable()
            .HtmlAttributes(new { style = "height:430px;" })
            .DataSource(dataSource => dataSource
                .Ajax()
                .PageSize(20)
                .Events(events => events.Error("error_handler"))
                .Model(model =>
                {
                    model.Id(p => p.Codice);
                    model.Field(e => e.Codice).Editable(true);
                    model.Field(e => e._listaAttributi).DefaultValue(new List<Attributo>());
                })
                            //.Create(update => update.Action("TipiAllegati_Create", "Docs"))
                            .Read(read => read.Action("TipiAllegati_Read", "Docs"))
                            .Update(update => update.Action("TipiAllegati_Update", "Docs"))
                            .Destroy(update => update.Action("TipiAllegati_Destroy", "Docs"))
                        )
                    )
                </div>
            </div>
        </div>
    </div>
</section>




<script type="text/javascript">
    $(function () {
        // The Name() of the Window is used to get its client-side instance.
        var dialog = $("#window").data("kendoWindow");
    });
</script>

<script type="text/javascript">
    var codiceDel = '';

    function showEditor(e) {
        e.preventDefault();
        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
        window.location.href = '/Docs/editTipoAllegato?Codice=' + dataItem.Codice;
    }
    /* button grid elimina tipoAllegato
 * chaima la funzione su DocsController per vedere se ci sono allegati collegati
 * se non ci sono apre il dialog di conferma eliminazione
 **/
    function eliminaTipoAllegato(e) {

        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
        var cod = dataItem.Codice;
        codiceDel = cod;
        var obj2 = {
            Tipo: "TipoAllegato",
            Cod: cod
        };

         $.ajax({
            type: "POST",
            url: "@(Url.Action("checkIfDeletable", "Docs"))",
            data: obj2,
            success: function (result) {
                if (!result) alert("Impossibile eliminare: presenti allegati associati");
                else {
                    $("#dialogConferma").data("kendoDialog").open();
                }

            }
        });
    }
     function onAnnullaEliminazione() {
        $("#dialogConferma").data("kendoDialog").close();
    }
    //eliminazione tipoAllegato
    function onConfermaEliminazione() {
         $.ajax({
            type: "POST",
            url: "@(Url.Action("TipiAllegati_Destroy", "Docs"))",
            data: {codice: codiceDel},
            success: function (result) {
                $("#gridTipiAllegati").data("kendoGrid").dataSource.read();
            }
          });
        $("#gridTipiAllegati").data("kendoGrid").dataSource.read();
    }
    function duplica(e) {
        e.preventDefault();
        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
        window.location.href = '/Docs/duplicaTipoAllegato?Codice=' + dataItem.Codice;
    }


</script>

<script type="text/javascript">

    function error_handler(e) {
        if (e.errors) {
            var message = "Errors:\n";
            $.each(e.errors, function (key, value) {
                if ('errors' in value) {
                    $.each(value.errors, function () {
                        message += this + "\n";
                    });
                }
            });
            alert(message);
        }
    }

    $(document).ready(function () {

             var myWindow = $("#window");

                $("#AddTipoAllegato").bind("click", function () {
                    $.ajax({
                        type: "POST",
                        url: "@(Url.Action("TipiAllegati_Create", "Docs"))",

                        success: function (result) {
                            window.location.href = '/Docs/editTipoAllegato?Codice=' + result.Codice;
                            //var myWindow = $("#window").data("kendoWindow");
                            //$("#CodTipo").val(result.Codice);
                            //myWindow.refresh({
                            //    url: "/Docs/editTipoAllegato",
                            //    data: { codice: result.Codice },
                            //    type: "Post"
                            //});
                            // myWindow.open().maximize();
                        }
                    });

                     //.open();
                });
         });
</script>


@(Html.Kendo().Window()
                .Name("window")
    .Size("auto")
    .Title("Tipo Allegato")
    .Visible(false)
    .Actions(actions => actions.Refresh().Minimize().Maximize().Close())
    .Content("")
    .Scrollable(true)
    .Draggable(false)
    .Resizable( )
    .Modal(true)
)

<script>
    function window_open() {
        // Handle the open event.
    }

    function window_close() {
        // Handle the close event.
    }
</script>